<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Composer</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
</head>
<body>
    <div id="app">
        <header>
            <h1><a href="#" id="app-title" class="app-title-link">Time Composer</a></h1>
            <nav>
                <button class="nav-btn active" data-view="dashboard">Dashboard</button>
                <button class="nav-btn" data-view="calendar">Calendar</button>
                <button class="nav-btn" data-view="export">Export</button>
            </nav>
        </header>

        <main>
            <!-- Dashboard View -->
            <div id="dashboard-view" class="view active">
                
                <!-- Streamlined Controls -->
                <div class="streamlined-controls">
                    <input type="text" id="search" placeholder="Search entries..." class="search-input">
                    
                    <button id="view-toggle" class="control-btn icon-btn" title="Toggle between list and card view">
                        <svg id="list-view-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" width="22" height="22">
                            <line x1="4" y1="6" x2="20" y2="6"></line>
                            <line x1="4" y1="12" x2="20" y2="12"></line>
                            <line x1="4" y1="18" x2="20" y2="18"></line>
                        </svg>
                        <svg id="card-view-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" width="22" height="22" style="display: none;">
                            <rect x="5" y="4" width="14" height="16" rx="2"></rect>
                            <line x1="9" y1="8" x2="15" y2="8" stroke-width="1"></line>
                            <line x1="9" y1="12" x2="15" y2="12" stroke-width="1"></line>
                        </svg>
                    </button>
                    
                    <div class="filter-dropdown">
                        <button id="status-filter-btn" class="control-btn text-btn" title="Filter by status">
                            <span class="btn-text" id="status-filter-text">All</span>
                            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                                <path d="M7,10L12,15L17,10H7Z"/>
                            </svg>
                        </button>
                        <div id="status-dropdown" class="dropdown-menu hidden">
                            <button class="dropdown-item active" data-status="">All</button>
                            <button class="dropdown-item" data-status="draft">Draft</button>
                            <button class="dropdown-item" data-status="exported">Exported</button>
                        </div>
                    </div>
                    
                    
                    <button id="add-time-entry" class="add-entry-btn">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
                            <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
                        </svg>
                        Add Entry
                    </button>
                </div>
                
                <!-- Advanced Filters Panel (simplified) -->
                <div id="advanced-filters" class="advanced-filters hidden">
                    <div class="filters-content">
                        <div class="filters-grid">
                            <div class="filter-group">
                                <label>Status</label>
                                <select id="status-filter">
                                    <option value="">All</option>
                                    <option value="draft">Draft</option>
                                    <option value="exported">Exported</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Client</label>
                                <select id="client-filter">
                                    <option value="">All Clients</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Matter</label>
                                <select id="matter-filter">
                                    <option value="">All Matters</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Hours Range</label>
                                <select id="hours-filter">
                                    <option value="">All Hours</option>
                                    <option value="0.5-1">0.5 - 1.0 hrs</option>
                                    <option value="1-2">1.0 - 2.0 hrs</option>
                                    <option value="2-5">2.0 - 5.0 hrs</option>
                                    <option value="5+">5.0+ hrs</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Task Code</label>
                                <input type="text" id="task-filter" placeholder="e.g., L310">
                            </div>
                        </div>
                        <div class="filters-actions">
                            <button id="clear-all-filters" class="secondary-btn">Clear All</button>
                            <button id="apply-filters" class="primary-btn">Apply Filters</button>
                        </div>
                    </div>
                </div>
                
                
                <div id="entries-list" class="entries-container">
                    <!-- Entries will be populated here -->
                </div>
                
                <!-- Bulk Actions Bar -->
                <div id="bulk-actions" class="bulk-actions">
                    <span class="bulk-actions-count" id="bulk-count">0 selected</span>
                    <button class="bulk-duplicate-btn" id="bulk-duplicate">Duplicate</button>
                    <button class="bulk-delete-btn" id="bulk-delete">Delete</button>
                    <button class="bulk-cancel-btn" id="bulk-cancel">Cancel</button>
                </div>
            </div>

            <!-- Calendar View -->
            <div id="calendar-view" class="view">
                <div class="calendar-header">
                    <button id="prev-month" class="calendar-nav">←</button>
                    <h2 id="calendar-month"></h2>
                    <button id="next-month" class="calendar-nav">→</button>
                </div>
                <div id="calendar"></div>
            </div>

            <!-- Export View -->
            <div id="export-view" class="view">
                <div class="export-container">
                    <!-- Export Controls Card -->
                    <div class="export-card">
                        <div class="card-body">
                            <!-- Date Selection Section -->
                            <div class="date-selection-section">
                                <label class="section-label">Date Range</label>
                                <div class="date-controls-row">
                                    <div class="date-presets">
                                        <button class="preset-btn" data-preset="today">Today</button>
                                        <button class="preset-btn" data-preset="this-week">This Week</button>
                                        <button class="preset-btn" data-preset="this-month">This Month</button>
                                        <button class="preset-btn" data-preset="last-month">Last Month</button>
                                    </div>
                                    <div class="date-range-inputs">
                                        <div class="date-separator"></div>
                                        <div class="date-input-group compact">
                                            <label for="export-start">From</label>
                                            <input type="date" id="export-start" class="date-input compact">
                                        </div>
                                        <div class="date-input-group compact">
                                            <label for="export-end">To</label>
                                            <input type="date" id="export-end" class="date-input compact">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- File Name Section -->
                            <div class="filename-section">
                                <label for="export-filename" class="section-label">File Name</label>
                                <div class="filename-content">
                                    <div>
                                        <div class="filename-input-wrapper">
                                            <input type="text" id="export-filename" placeholder="time-entries" class="filename-input">
                                            <span class="filename-extension">.csv</span>
                                        </div>
                                        <p class="field-hint">Leave blank for auto-generated filename with date</p>
                                    </div>
                                    <button id="export-btn" class="export-button">
                                        <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
                                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M16,11L12,15L8,11L10.17,9L11,9.83V7H13V9.83L13.83,9L16,11Z"/>
                                        </svg>
                                        Export to CSV
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Statistics Card -->
                    <div class="export-stats-card" id="export-stats">
                    <div class="stat-item">
                        <div class="stat-icon">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                                <path d="M16,15H9V13H16M19,11H9V9H19M19,7H9V5H19M6,17V3H21V17C21,18.1 20.1,19 19,19H8L6,17M21,1H6C4.89,1 4,1.89 4,3V17L8,21H19C21.1,21 23,19.1 23,17V3C23,1.89 22.1,1 21,1Z"/>
                            </svg>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value" id="stat-entries">0</div>
                            <div class="stat-label">Entries</div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                                <path d="M12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22C6.47,22 2,17.5 2,12A10,10 0 0,1 12,2M12.5,7V12.25L17,14.92L16.25,16.15L11,13V7H12.5Z"/>
                            </svg>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value" id="stat-hours">0.0</div>
                            <div class="stat-label">Total Hours</div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                                <path d="M19,3H18V1H16V3H8V1H6V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M19,19H5V8H19V19M9,10H7V12H9V10M13,10H11V12H13V10M17,10H15V12H17V10Z"/>
                            </svg>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value stat-date-range" id="stat-date-range">No date selected</div>
                            <div class="stat-label">Date Range</div>
                        </div>
                    </div>
                    </div>
                    
                    <!-- Preview Table Card -->
                    <div class="export-preview-card">
                    <div class="card-header">
                        <div class="header-title-group">
                            <h3>Preview</h3>
                            <span class="preview-count" id="preview-count"></span>
                        </div>
                        <label class="checkbox-wrapper compact">
                            <input type="checkbox" id="export-non-exported-only" class="styled-checkbox">
                            <span class="checkbox-label">Hide previously exported</span>
                        </label>
                    </div>
                    <div class="card-body">
                        <div id="export-preview" class="export-preview-table"></div>
                    </div>
                </div>
                </div>
            </div>
        </main>

        <!-- AI Assistant Interface -->
        <div id="ai-assistant" class="assistant-overlay">
            <div class="assistant-container">
                <div class="assistant-header">
                    <div class="assistant-title">
                        <div class="assistant-avatar">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                                <path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/>
                            </svg>
                        </div>
                        <div class="assistant-info">
                            <h2>Time Composer</h2>
                            <p class="assistant-status" id="assistant-status">Ready to capture your billable time</p>
                        </div>
                    </div>
                    <button class="close-btn" id="close-assistant">&times;</button>
                </div>

                <div class="conversation-area">
                    <div class="messages-container" id="messages-container">
                        <div class="message assistant-message initial-message">
                            <div class="message-avatar">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 6L13.5 10.5L18 12L13.5 13.5L12 18L10.5 13.5L6 12L10.5 10.5L12 6Z"/>
                                </svg>
                            </div>
                            <div class="message-content">
                                <div class="message-text">What billable work did you accomplish today? I'll help you turn it into professional time entries.</div>
                                <div class="suggested-actions">
                                    <button class="suggestion-btn" data-action="voice">
                                        <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                                            <path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/>
                                        </svg>
                                        Record
                                    </button>
                                    <button class="suggestion-btn" data-action="type">
                                        <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                                            <path d="M19,10H17V8H19M19,13H17V11H19M16,10H14V8H16M16,13H14V11H16M16,17H8V15H16M13,10H11V8H13M13,13H11V11H13M10,10H8V8H10M10,13H8V11H10M10,17H8V15H10M7,10H5V8H7M7,13H5V11H7M7,17H5V15H7M2,4V20A2,2 0 0,0 4,22H20A2,2 0 0,0 22,20V4A2,2 0 0,0 20,2H4A2,2 0 0,0 2,4Z"/>
                                        </svg>
                                        Type
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Voice Recording Interface -->
                    <div class="voice-interface hidden" id="voice-interface">
                        <div class="voice-recording-compact">
                            <div class="recording-bar">
                                <div class="recording-status-section">
                                    <div class="recording-info">
                                        <span class="recording-label" id="recording-label">Ready to record</span>
                                        <span class="recording-timer" id="recording-timer-compact">00:00</span>
                                    </div>
                                    <div class="audio-bars hidden" id="audio-bars">
                                        <span class="audio-bar"></span>
                                        <span class="audio-bar"></span>
                                        <span class="audio-bar"></span>
                                        <span class="audio-bar"></span>
                                        <span class="audio-bar"></span>
                                    </div>
                                </div>
                                <div class="recording-controls-section">
                                    <button id="voice-record-btn" class="voice-btn primary large">
                                        <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/>
                                        </svg>
                                        <span class="btn-text">Start Recording</span>
                                    </button>
                                    <div class="secondary-controls hidden" id="secondary-voice-controls">
                                        <button id="voice-pause-btn" class="compact-btn secondary">
                                            <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M14,19H18V5H14M6,19H10V5H6V19Z"/>
                                            </svg>
                                            <span class="btn-text">Pause</span>
                                        </button>
                                        <button id="voice-stop-btn" class="compact-btn danger">
                                            <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M18,18H6V6H18V18Z"/>
                                            </svg>
                                            <span class="btn-text">Stop</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Hidden live transcription area for technical use -->
                            <div class="live-transcription-area hidden" id="live-transcription-area" style="display: none;">
                                <div class="live-text-container">
                                    <div class="live-text" id="live-text-new"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Text Input Interface -->
                    <div class="text-interface hidden" id="text-interface">
                        <div class="text-input-area">
                            <div class="text-prompt">
                                <textarea 
                                    id="text-input" 
                                    placeholder="E.g., Spent 2 hours reviewing the Smith merger agreement, 30 minutes on client call with Jones Corp about contract amendments, and 1.5 hours drafting motion for summary judgment in the Williams case..."
                                    rows="6"
                                ></textarea>
                                <div class="text-controls">
                                    <button id="text-submit-btn" class="voice-btn primary">Process Text</button>
                                    <button id="text-clear-btn" class="voice-btn secondary">Clear</button>
                                </div>
                                <div class="keyboard-hint" style="font-size: 0.85em; color: #888; margin-top: 0.5rem;">
                                    Tip: Press Ctrl+Enter to submit
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="input-area" id="input-area">
                        <div class="input-suggestions">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Entry Modal -->
        <div id="edit-modal" class="edit-modal">
            <div class="edit-modal-content">
                <div class="edit-modal-header">
                    <h2>Edit Time Entry</h2>
                    <button class="close-btn" id="close-edit-modal">&times;</button>
                </div>
                
                <!-- Narratives -->
                <div id="edit-narratives-container">
                    <!-- Narrative items will be populated here -->
                </div>
                
                <div class="edit-modal-actions">
                    <button class="secondary-btn" id="cancel-edit">Cancel</button>
                    <button class="primary-btn" id="save-edit">Save Changes</button>
                </div>
            </div>
        </div>

        <!-- Apply to All Modal -->
        <div id="apply-to-all-modal" class="edit-modal">
            <div class="edit-modal-content compact">
                <div class="edit-modal-header">
                    <h2>Apply to All Narratives</h2>
                    <button class="close-btn" id="close-apply-to-all-modal">&times;</button>
                </div>
                
                <div class="apply-to-all-content">
                    <p class="modal-description">Enter values to apply to all narratives in this time entry. Only filled fields will be applied.</p>
                    
                    <div class="apply-fields-grid">
                        <div class="apply-field">
                            <label for="apply-client-code">Client Code</label>
                            <input type="text" id="apply-client-code" placeholder="e.g., ACME-001" class="apply-input">
                        </div>
                        <div class="apply-field">
                            <label for="apply-matter-number">Matter Number</label>
                            <input type="text" id="apply-matter-number" placeholder="e.g., 2024-1234" class="apply-input">
                        </div>
                    </div>
                    
                    <div class="apply-mode">
                        <label class="mode-option">
                            <input type="radio" name="apply-mode" value="fill-empty" id="mode-fill-empty">
                            <span>Only fill empty fields</span>
                        </label>
                        <label class="mode-option">
                            <input type="radio" name="apply-mode" value="overwrite" id="mode-overwrite" checked>
                            <span>Overwrite existing values</span>
                        </label>
                    </div>
                    
                    <div id="apply-preview" class="apply-preview hidden">
                        <span class="preview-text"></span>
                    </div>
                </div>
                
                <div class="edit-modal-actions">
                    <button class="secondary-btn" id="cancel-apply-to-all">Cancel</button>
                    <button class="primary-btn" id="apply-to-all-btn">Apply Changes</button>
                </div>
            </div>
        </div>

        <!-- Context Recording Inline Interface -->
        <div id="context-recorder-inline" class="context-recorder-inline">
            <div class="context-recorder-backdrop" onclick="closeContextRecorder()"></div>
            <div class="context-recorder-content">
                <div class="context-recorder-header">
                    <div class="context-header-info">
                        <span class="context-header-label">Adding context to:</span>
                        <span class="context-header-narrative" id="inline-narrative-preview"></span>
                    </div>
                    <button class="close-btn" onclick="closeContextRecorder()">&times;</button>
                </div>
                
                <div class="context-recorder-body">
                    <div class="context-controls">
                        <button id="context-record-btn" class="context-record-btn">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                                <path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/>
                            </svg>
                            <span class="btn-text">Start Recording</span>
                        </button>
                        
                        <div class="context-status">
                            <span id="context-status-text">Ready to record additional details</span>
                            <span id="context-timer" class="context-timer"></span>
                        </div>
                    </div>
                    
                    <div id="context-transcription" class="context-transcription hidden">
                        <div class="transcription-content" id="context-live-text"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Processing Overlay -->
        <div id="loading-overlay" class="loading-overlay hidden">
            <div class="processing-container">
                <div class="processing-header">
                    <h3 id="processing-title">Processing your time entry</h3>
                    <p id="processing-subtitle">AI agents are transforming your speech into professional billing narratives</p>
                </div>
                
                <div class="agent-pipeline">
                    <div class="agent-step" id="step-transcription">
                        <div class="step-icon">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                                <path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/>
                            </svg>
                        </div>
                        <div class="step-content">
                            <div class="step-title">Transcribing Audio</div>
                            <div class="step-description">Converting speech to text using Whisper AI</div>
                        </div>
                        <div class="step-status">
                            <div class="status-spinner"></div>
                        </div>
                    </div>
                    
                    <div class="agent-step" id="step-grammar">
                        <div class="step-icon">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                                <path d="M14.6,16.6L19.2,12L14.6,7.4L16,6L22,12L16,18L14.6,16.6M9.4,16.6L4.8,12L9.4,7.4L8,6L2,12L8,18L9.4,16.6M17,2V4H15V2H17M13,2V4H11V2H13M9,2V4H7V2H9Z"/>
                            </svg>
                        </div>
                        <div class="step-content">
                            <div class="step-title">Grammar Agent</div>
                            <div class="step-description">Fixing grammar, spelling, and expanding abbreviations</div>
                        </div>
                        <div class="step-status">
                            <div class="status-pending"></div>
                        </div>
                    </div>
                    
                    <div class="agent-step" id="step-separator">
                        <div class="step-icon">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                                <path d="M14,2A8,8 0 0,1 22,10A8,8 0 0,1 14,18A8,8 0 0,1 6,10A8,8 0 0,1 14,2M14,4A6,6 0 0,0 8,10A6,6 0 0,0 14,16A6,6 0 0,0 20,10A6,6 0 0,0 14,4M14,6A4,4 0 0,1 18,10A4,4 0 0,1 14,14A4,4 0 0,1 10,10A4,4 0 0,1 14,6M14,8A2,2 0 0,0 12,10A2,2 0 0,0 14,12A2,2 0 0,0 16,10A2,2 0 0,0 14,8Z"/>
                            </svg>
                        </div>
                        <div class="step-content">
                            <div class="step-title">Separator Agent</div>
                            <div class="step-description">Identifying distinct billable activities and time allocations</div>
                        </div>
                        <div class="step-status">
                            <div class="status-pending"></div>
                        </div>
                    </div>
                    
                    <div class="agent-step" id="step-refiner">
                        <div class="step-icon">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                                <path d="M12,2L13.09,8.26L22,9L13.09,9.74L12,16L10.91,9.74L2,9L10.91,8.26L12,2Z"/>
                            </svg>
                        </div>
                        <div class="step-content">
                            <div class="step-title">Refiner Agent</div>
                            <div class="step-description">Transforming activities into professional billing narratives</div>
                        </div>
                        <div class="step-status">
                            <div class="status-pending"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/database.js"></script>
    <script src="js/api.js"></script>
    <script src="js/recording.js"></script>
    <script src="js/ai-assistant.js"></script>
    <script src="js/sync.js"></script>
    <script src="js/app.js"></script>
</body>
</html>